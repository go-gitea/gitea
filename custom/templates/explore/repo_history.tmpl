{{/* Template for rendering fork hierarchy nodes recursively */}}
{{define "fork_hierarchy_node"}}
    {{$node := .Node}}
    {{$currentRepo := .CurrentRepo}}
    {{$ctx := .ctx}}

    {{if and $node $node.Repository}}

    <div class="item fork-level-{{$node.Level}}">
        <div class="ui grid">
            <div class="two wide column">
                {{if $node.Repository.Owner}}
                    {{ctx.AvatarUtils.Avatar $node.Repository.Owner 32}}
                {{else}}
                    {{svg "octicon-person" 32}}
                {{end}}
            </div>
            <div class="fourteen wide column">
                <div class="content">
                    <div class="header">
                        {{/* Indentation indicators for hierarchy levels */}}
                        {{if gt $node.Level 0}}
                            {{if eq $node.Level 1}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                            {{if eq $node.Level 2}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                            {{if gt $node.Level 2}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                        {{end}}

                        <a class="ui large text" href="/subject/{{$node.Repository.GetSubject}}">
                            <strong>{{if $node.Repository.Owner}}{{$node.Repository.Owner.Name}}{{else}}unknown{{end}}/{{$node.Repository.Name}}</strong>
                        </a>

                        <span class="ui small labels">
                            {{if eq $node.Level 0}}
                                <span class="ui blue label">
                                    {{svg "octicon-repo" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.root"}}
                                </span>
                            {{else}}
                                <span class="ui basic label">
                                    {{svg "octicon-repo-forked" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.fork"}}
                                </span>
                            {{end}}

                            {{if eq $node.Repository.FullName $currentRepo.FullName}}
                                <span class="ui green label">
                                    {{svg "octicon-eye" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.current"}}
                                </span>
                            {{end}}

                            {{if $node.Repository.IsPrivate}}
                                <span class="ui basic label">
                                    {{svg "octicon-lock" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.desc.private"}}
                                </span>
                            {{end}}

                            {{if $node.Repository.IsArchived}}
                                <span class="ui basic label">
                                    {{svg "octicon-archive" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.desc.archived"}}
                                </span>
                            {{end}}
                        </span>
                    </div>

                    {{if $node.Repository.Description}}
                        <div class="description tw-mt-2">
                            {{$node.Repository.Description}}
                        </div>
                    {{end}}

                    <div class="extra tw-mt-3">
                        <div class="ui horizontal list">
                            <div class="item">
                                <i class="clock icon"></i>
                                {{if $node.Repository.UpdatedUnix}}
                                    {{ctx.Locale.Tr "repo.last_updated"}} {{DateUtils.TimeSince $node.Repository.UpdatedUnix}}
                                {{else}}
                                    {{ctx.Locale.Tr "repo.never_updated"}}
                                {{end}}
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/stars" class="ui basic mini label">
                                    {{svg "octicon-star" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumStars}}
                                </a>
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/forks" class="ui basic mini label">
                                    {{svg "octicon-repo-forked" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumForks}}
                                </a>
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/issues" class="ui basic mini label">
                                    {{svg "octicon-issue-opened" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumIssues}}
                                </a>
                            </div>
                            {{if $node.Repository.PrimaryLanguage}}
                                <div class="item">
                                    <span class="ui basic mini label">
                                        <i class="circle icon" style="color: {{$node.Repository.PrimaryLanguage.Color}}"></i>
                                        {{$node.Repository.PrimaryLanguage.Language}}
                                    </span>
                                </div>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{/* Recursively render children */}}
    {{range $node.Children}}
        {{template "fork_hierarchy_node" (dict "Node" . "CurrentRepo" $currentRepo "ctx" $ctx)}}
    {{end}}
    {{end}}
{{end}}

{{template "base/head" .}}
<style>
/* Temporary Fork hierarchy level styling until we agree on design */
.fork-level-0 { margin-left: 0px !important; }
.fork-level-1 { margin-left: 20px !important; }
.fork-level-2 { margin-left: 40px !important; }
.fork-level-3 { margin-left: 60px !important; }
.fork-level-4 { margin-left: 80px !important; }
.fork-level-5 { margin-left: 100px !important; }
/* Articles table spacing */
#articles-table col.checkbox { width: 10px; }
#articles-table col.actions { width: 80px; }
#bubble-view-root {
    height: calc(100vh - 25rem);
    overflow: auto;
    margin-bottom: calc(0px - var(--page-space-bottom));
    margin-top: -1rem;
    margin-left: -1rem;
    margin-right: -1rem;
    width: calc(100% + 2rem);
}
</style>
<div role="main" aria-label="{{.Title}}" class="page-content repository file list">
    {{/* Login banner for non-authenticated users */}}
    {{if and .IsArticleModeEdit (not .IsSigned)}}
    <div class="ui warning message tw-mt-0">
        <div class="tw-flex tw-items-center tw-gap-2">
            {{svg "octicon-alert" 16}}
            <span class="tw-color-text">You are not logged in. You have to <a href="{{AppSubUrl}}/user/login?redirect_to={{QueryEscape .Link}}">Sign in</a> / <a href="{{AppSubUrl}}/user/sign_up?redirect_to={{QueryEscape .Link}}">Sign up</a> in order to do edits.</span>
        </div>
    </div>
    {{end}}
    {{template "repo/header" .}}


    <div class="ui container">
        {{/* Wrapper for the 3 views controlled by query param "view" */}}

        {{if .IsRepoEmpty}}
            {{template "repo/empty" .}}
        {{else}}
            {{/* Bubble view */}}
            {{if .IsBubbleView}}
            
            <div id="bubble-view-root"
                data-owner="{{.Repository.Owner.Name}}"
                data-repo="{{.Repository.Name}}"
                data-subject="{{.Repository.GetSubject}}"
                data-api-url="{{AppSubUrl}}/api/v1/repos/{{.Repository.Owner.Name}}/{{.Repository.Name}}/forks/graph">
            </div>
            
            {{end}}

            {{/* Table view */}}
            {{if .IsTableView}}
            <div class="ui stackable grid tw-mt-20">
                <div class="sixteen wide column">
                    <div class="tw-flex tw-items-center tw-justify-between tw-gap-4 tw-px-0 tw-border-0">
                        <h2 class="tw-text-xl tw-font-semibold tw-m-0">Articles</h2>
                        <div class="tw-flex tw-items-center tw-gap-2">
                            <div class="ui floating dropdown button tw-border-0 tw-bg-transparent tw-shadow-none tw-hover:bg-transparent tw-active:bg-transparent tw-pr-0">
                                <div style="transform: rotate(90deg);">
                                    {{svg "octicon-arrow-switch" 16}}
                                </div>
                                <span class="text tw-ml-1">Sort</span>
                                {{svg "octicon-triangle-down" 16 "tw-ml-1"}}
                                <div class="menu">
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "most_contrib"}}">Most contributors</a>
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "least_contrib"}}">Least contributors</a>
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "latest"}}">Latest edited</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ui segment tw-px-0">
                        <table class="ui unstackable very basic fixed single line selectable table tw-mb-0" id="articles-table">
                            <colgroup>
                                <col class="checkbox">
                                <col>
                                <col>
                                <col>
                                <col class="actions">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="five wide">Contributors</th>
                                    <th class="three wide">Last edited</th>
                                    <th class="four wide">Owner</th>
                                    <th class="collapsing"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range $idx, $f := .Files}}
                                {{$name := .Name}}
                                <tr class="article-row" data-row="{{$idx}}" data-owner="{{$.Repository.Owner.Name}}" data-subject="{{$.Repository.GetSubject}}">
                                    <td>
                                        <div class="ui checkbox">
                                            <input type="checkbox" class="row-check">
                                            <label></label>
                                        </div>
                                    </td>
                                    <td class="tw-font-semibold">{{CountFmt $.ContributorCount}}</td>
                                    <td>{{if $.LastCommit}}{{DateUtils.AbsoluteShort $.LastCommit.Committer.When}}{{end}}</td>
                                    <td>{{if $.Repository.Owner}}{{$.Repository.Owner.Name}}{{else}}-{{end}}</td>
                                    <td class="collapsing tw-text-right">
                                        <button type="button" class="ui icon button row-toggle tw-border-0 tw-bg-transparent" data-target="desc-{{$idx}}" aria-label="Toggle description">
                                            <span class="icon-down">{{svg "octicon-chevron-down"}}</span>
                                            <span class="icon-up tw-hidden">{{svg "octicon-chevron-up"}}</span>
                                        </button>
                                    </td>
                                </tr>
                                <tr id="desc-{{$idx}}" class="tw-hidden">
                                    <td colspan="5">
                                        <div class="tw-pl-8 tw-pr-4 tw-py-4 tw-flex tw-items-start tw-justify-between tw-gap-4">
                                            <div class="tw-text-gray-600 tw-text-sm tw-leading-6">
                                                {{if $.Repository.Description}}
                                                    {{$.Repository.Description}}
                                                {{else}}
                                                    {{if $.LastCommit}}{{$.LastCommit.Summary}}{{end}}
                                                {{end}}
                                            </div>
                                            <a class="ui button go-to-article" href="{{printf "%s/article/%s/%s?view=article&mode=read" AppSubUrl $.Repository.Owner.Name $.Repository.GetSubject}}">Go to article</a>
                                        </div>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
            // TODO: Double check that this code should be moved to a common file
            (function(){
                const table = document.getElementById('articles-table');
                if(!table) return;
                const selectAll = document.getElementById('select-all-articles');
                if (selectAll) {
                    selectAll.addEventListener('change', function(){
                        table.querySelectorAll('tbody .row-check').forEach(cb=>{ cb.checked = selectAll.checked; });
                    });
                }
                table.querySelectorAll('.row-toggle').forEach(btn=>{
                    btn.addEventListener('click', function(){
                        const id = this.getAttribute('data-target');
                        const row = document.getElementById(id);
                        if(!row) return;
                        row.classList.toggle('tw-hidden');
                        const down = this.querySelector('.icon-down');
                        const up = this.querySelector('.icon-up');
                        if (row.classList.contains('tw-hidden')) {
                            // now collapsed
                            if (down) down.classList.remove('tw-hidden');
                            if (up) up.classList.add('tw-hidden');
                        } else {
                            // now expanded
                            if (down) down.classList.add('tw-hidden');
                            if (up) up.classList.remove('tw-hidden');
                        }
                    });
                });
                // enable Fomantic dropdowns
                if (window.$ && $('.ui.dropdown').dropdown) { $('.ui.dropdown').dropdown(); }
            })();
            </script>
            {{end}}

            {{/* Article view - display README of repository (if exists) */}}
            {{if .IsArticleView}}
            <div class="ui tw-mt-10">
                {{if .IsSubjectContext}}
                    <div class="ui info message" id="article-guidance" style="display:none">
                        {{svg "octicon-info" 16}}
                        <span class="tw-ml-2">Select an article in Bubble view or Table view to open its Article page.</span>
                    </div>
                {{end}}
                {{if .ReadmeError}}
                    <div class="ui error message">
                        {{.ReadmeError}}
                    </div>
                {{else}}
                    {{/* Contributors and Last Updated Pills */}}
                    <div class="tw-flex tw-items-center tw-gap-2">
                        <span class="pill">
                            {{svg "octicon-person" 16 "tw-mr-1"}}
                            {{.ReadmeContributorCount}} {{if eq .ReadmeContributorCount 1}}contributor{{else}}contributors{{end}}
                        </span>
                        {{if .ReadmeLastCommit}}
                            <span class="pill">
                                {{svg "octicon-sync" 16 "tw-mr-1"}}
                                Updated {{DateUtils.TimeSince .ReadmeLastCommit.Committer.When}}
                            </span>
                        {{end}}
                    </div>
                    {{/* Tab navigation for Read/Edit/History */}}
                    {{/* pierre: Read/Edit/History should go under the url "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name .Repository.GetSubject e.g. /article/wikipedia/Moon%20Landing */}}
                    <div class="tw-flex tw-items-center tw-gap-4" id="article-tabs">
                        <div class="ui top attached tabular menu tw-my-10 tw-gap-1">
                            <a class="{{if .IsArticleModeRead}}active {{end}}item" href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name .Repository.GetSubject) "view" "article" "mode" "read"}}" data-article-tab="read">
                                {{svg "octicon-book" 16}} Read
                            </a>
                            <a class="{{if .IsArticleModeEdit}}active {{end}}item" href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name .Repository.GetSubject) "view" "article" "mode" "edit"}}" data-article-tab="edit">
                                {{svg "octicon-pencil" 16}} Edit
                            </a>
                            <a class="{{if .IsArticleModeHistory}}active {{end}}item" href="{{QueryBuild (printf "%s/article/%s/%s" AppSubUrl .Repository.Owner.Name .Repository.GetSubject) "view" "article" "mode" "history"}}" data-article-tab="history">
                                {{svg "octicon-history" 16}} History
                            </a>
                            {{/* Align buttons on the right */}}
                            <div class="tw-flex tw-items-center tw-gap-2 tw-ml-auto">
                                {{if .IsArticleModeRead}}
                                    <div class="tw-flex">
                                        {{template "repo/watch_unwatch" .}}
                                    </div>
                                    <div class="ui icon top left pointing dropdown button mini tw-px-3">
                                        {{svg "octicon-kebab-horizontal" 14}}
                                        <div class="menu">
                                            <div class="item">Something</div>
                                        </div>
                                    </div>
                                {{end}}
                                {{if .IsArticleModeEdit}}
                                    {{/* Action buttons above editor */}}
                                    <div class="tw-flex tw-items-center tw-justify-between tw-mb-4">
                                        <div class="tw-flex tw-items-center tw-gap-2">
                                            <button type="button" id="fork-button" class="ui button{{if not .IsSigned}} disabled{{end}}" data-repo-link="{{.RepoLink}}">
                                                {{svg "octicon-repo-forked" 16 "tw-mr-1"}}
                                                Fork
                                            </button>
                                            <button type="button" id="submit-changes-button" class="ui primary button{{if not .IsSigned}} disabled{{end}}">
                                                {{svg "octicon-check" 16 "tw-mr-1"}}
                                                Submit Changes
                                            </button>
                                        </div>
                                    </div>
                                {{end}}
                                {{if .IsArticleModeHistory}}
                                    <div class="ui icon top left pointing dropdown button mini tw-px-3">
                                        {{svg "octicon-kebab-horizontal" 14}}
                                        <div class="menu">
                                            <div class="item">Something</div>
                                        </div>
                                    </div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    {{/* Read mode - Display rendered README */}}
                    {{if .IsArticleModeRead}}
                    <div class="ui bottom attached">
                        <div class="tw-mb-4 tw-flex tw-items-center tw-justify-between">
                            <div>
                                <h2 class="tw-text-xl tw-font-semibold tw-m-0">
                                    {{/* owner / repo */}}
                                    {{if .Repository.Owner}}
                                        <a class="tw-text-primary" href="{{.Repository.Owner.HomeLink}}">{{.Repository.Owner.Name}}</a>
                                        <span class="tw-text-gray-400">/</span>
                                    {{end}}
                                    <a class="muted" href="{{.RepoLink}}">{{.Repository.Name}}</a>
                                </h2>
                                <div class="tw-mt-1 tw-text-sm tw-text-gray-600">
                                    {{if .Repository.IsFork}}
                                        <span class="tw-inline-flex tw-items-center">
                                            {{svg "octicon-repo-forked" 14 "tw-mr-1"}}
                                            Forked of:
                                            {{if .Repository.BaseRepo}}
                                                <a class="tw-ml-1" href="{{.Repository.BaseRepo.Link}}">{{.Repository.BaseRepo.OwnerName}} / {{.Repository.BaseRepo.Name}}</a>
                                            {{else}}
                                                <span class="tw-ml-1">{{.Repository.Owner.Name}} / {{.Repository.Name}}</span>
                                            {{end}}
                                        </span>
                                    {{end}}
                                </div>
                            </div>
                            <div class="tw-flex tw-items-center tw-gap-3">
                                <a class="tw-font-bold tw-inline-flex tw-items-center muted" href="#" data-global-click="onCopyContentButtonClick" data-clipboard-text="{{.Repository.Owner.Name}}/{{.Repository.Name}}@{{.BranchName}}">
                                    {{svg "octicon-link" 14 "tw-mr-1"}} CopyRef
                                </a>
                            </div>
                        </div>
                        <div class="tw-mb-3 tw-text-sm tw-text-gray-600 tw-flex tw-items-center">
                            {{svg "octicon-check-circle" 16 "tw-mr-2 tw-text-primary"}}
                            <span>James99 and <a class="tw-text-primary" href="#">3 others</a> you know marked this article as correct.</span>
                        </div>
                        {{if .IsFileTooLarge}}
                            <div class="ui error message">
                                {{ctx.Locale.Tr "repo.file_too_large"}}
                            </div>
                        {{else}}
                            <div class="file-view {{if .IsMarkup}}markup {{.MarkupType}}{{else if .IsPlainText}}plain-text{{end}}">
                                {{if .IsMarkup}}
                                    {{.FileContent}}
                                {{else if .IsPlainText}}
                                    <pre>{{if .FileContent}}{{.FileContent}}{{end}}</pre>
                                {{end}}
                            </div>
                        {{end}}
                    </div>
                    {{end}}

                    {{/* Edit mode - Display editor */}}
                    {{if .IsArticleModeEdit}}
                    <div class="ui bottom attached">
                        <div class="tw-mb-4 tw-flex tw-items-center tw-justify-between">
                            <div>
                                <h2 class="tw-text-xl tw-font-semibold tw-m-0">
                                    {{/* owner / repo */}}
                                    {{if .Repository.Owner}}
                                        <a class="tw-text-primary" href="{{.Repository.Owner.HomeLink}}">{{.Repository.Owner.Name}}</a>
                                        <span class="tw-text-gray-400">/</span>
                                    {{end}}
                                    <a class="muted" href="{{.RepoLink}}">{{.Repository.Name}}</a>
                                </h2>
                                <div class="tw-mt-1 tw-text-sm tw-text-gray-600">
                                    {{if .Repository.IsFork}}
                                        <span class="tw-inline-flex tw-items-center">
                                            {{svg "octicon-repo-forked" 14 "tw-mr-1"}}
                                            Forked of:
                                            {{if .Repository.BaseRepo}}
                                                <a class="tw-ml-1" href="{{.Repository.BaseRepo.Link}}">{{.Repository.BaseRepo.OwnerName}} / {{.Repository.BaseRepo.Name}}</a>
                                            {{else}}
                                                <span class="tw-ml-1">{{.Repository.Owner.Name}} / {{.Repository.Name}}</span>
                                            {{end}}
                                        </span>
                                    {{end}}
                                </div>
                            </div>
                            <div class="tw-flex tw-items-center tw-gap-3">
                                <a class="tw-font-bold tw-inline-flex tw-items-center muted" href="#" data-global-click="onCopyContentButtonClick" data-clipboard-text="{{.Repository.Owner.Name}}/{{.Repository.Name}}@{{.BranchName}}">
                                    {{svg "octicon-link" 14 "tw-mr-1"}} CopyRef
                                </a>
                            </div>
                        </div>
                        {{if .NotEditableReason}}
                            <div class="ui warning message">
                                <h4>{{.NotEditableReason}}</h4>
                                <p>{{ctx.Locale.Tr "repo.editor.file_not_editable_hint"}}</p>
                            </div>
                        {{else}}
                            {{/* Editor form */}}
                            <form class="ui edit form" id="article-edit-form" method="post" action="{{.RepoLink}}/_edit/{{PathEscapeSegments .BranchName}}/{{.ReadmeTreePath}}">
                                {{.CsrfTokenHtml}}
                                <input type="hidden" name="last_commit" value="{{.LastCommitID}}">
                                <input type="hidden" name="tree_path" value="{{.ReadmeTreePath}}">
                                
                                 <div class="field">
                                     <div class="tw-p-0">
                                         <textarea id="edit_area" name="content" class="tw-hidden" data-id="repo-{{.Repository.Name}}-{{.ReadmeTreePath}}">{{.FileContent}}</textarea>
                                         <div class="editor-loading is-loading"></div>
                                         <div id="toast-editor-container" style="min-height: 500px;"></div>
                                     </div>
                                 </div>
                            </form>
                        {{end}}
                    </div>
                    {{end}}

                    {{/* History mode - Display commit history */}}
                    {{if .IsArticleModeHistory}}
                    <div class="ui bottom attached">
                        <div>
                            <h2 class="tw-text-xl tw-font-semibold tw-m-0">
                                {{/* owner / repo */}}
                                {{if .Repository.Owner}}
                                    <a class="tw-text-primary" href="{{.Repository.Owner.HomeLink}}">{{.Repository.Owner.Name}}</a>
                                    <span class="tw-text-gray-400">/</span>
                                {{end}}
                                <a class="muted" href="{{.RepoLink}}">{{.Repository.Name}}</a>
                            </h2>
                            <div class="tw-mt-1 tw-text-sm tw-text-gray-600">
                                {{if .Repository.IsFork}}
                                    <span class="tw-inline-flex tw-items-center">
                                        {{svg "octicon-repo-forked" 14 "tw-mr-1"}}
                                        Forked of:
                                        {{if .Repository.BaseRepo}}
                                            <a class="tw-ml-1" href="{{.Repository.BaseRepo.Link}}">{{.Repository.BaseRepo.OwnerName}} / {{.Repository.BaseRepo.Name}}</a>
                                        {{else}}
                                            <span class="tw-ml-1">{{.Repository.Owner.Name}} / {{.Repository.Name}}</span>
                                        {{end}}
                                    </span>
                                {{end}}
                            </div>
                        </div>
                        {{if .Commits}}
                            <div class="ui attached table segment commit-table tw-mt-10">
                                <table class="ui very basic striped table unstackable" id="commits-table">
                                    <thead>
                                        <tr>
                                            <th class="three wide">{{ctx.Locale.Tr "repo.commits.user"}}</th>
                                            <th class="two wide sha">{{ctx.Locale.Tr "repo.commits.code"}}</th>
                                            <th class="eight wide message">{{ctx.Locale.Tr "repo.commits.message"}}</th>
                                            <th class="two wide tw-text-right">{{ctx.Locale.Tr "repo.commits.date"}}</th>
                                            <th class="one wide"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="commit-list">
                                        {{range .Commits}}
                                        <tr>
                                            <td class="author">
                                                <div class="tw-flex tw-font-bold">
                                                    {{$userName := .Author.Name}}
                                                    {{if .User}}
                                                        {{if and .User.FullName DefaultShowFullName}}
                                                            {{$userName = .User.FullName}}
                                                        {{end}}
                                                        {{ctx.AvatarUtils.Avatar .User 28 "tw-mr-2 tw-border tw-rounded-full"}}<a class="muted author-wrapper" href="{{.User.HomeLink}}">{{$userName}}</a>
                                                    {{else}}
                                                        {{ctx.AvatarUtils.AvatarByEmail .Author.Email .Author.Name 28 "tw-mr-2"}}
                                                        <span class="author-wrapper">{{$userName}}</span>
                                                    {{end}}
                                                </div>
                                            </td>
                                            <td class="sha">
                                                <a href="{{$.RepoLink}}/commit/{{.ID.String}}" rel="nofollow" class="muted">
                                                    {{ShortSha .ID.String}}
                                                </a>
                                            </td>
                                            <td class="message">
                                                <span class="message-wrapper">
                                                    <span class="commit-summary" title="{{.Summary}}">{{.Summary | ctx.RenderUtils.RenderEmoji}}</span>
                                                </span>
                                            </td>
                                            {{if .Committer}}
                                                <td class="tw-text-right">{{DateUtils.TimeSince .Committer.When}}</td>
                                            {{else}}
                                                <td class="tw-text-right">{{DateUtils.TimeSince .Author.When}}</td>
                                            {{end}}
                                            <td class="tw-text-right tw-py-0">
                                                <a class="btn interact-bg tw-p-2" data-tooltip-content="{{ctx.Locale.Tr "repo.commits.view_path"}}" href="{{$.RepoLink}}/src/commit/{{PathEscape .ID.String}}/{{PathEscapeSegments $.ReadmeTreePath}}">
                                                    {{if $.Repository.IsFork}}
                                                        {{svg "octicon-repo-forked" 16}}
                                                    {{else}}
                                                        {{svg "octicon-git-commit" 16}}
                                                    {{end}}
                                                </a>
                                            </td>
                                        </tr>
                                        {{end}}
                                    </tbody>
                                </table>
                            </div>
                            {{if .Page}}
                                {{template "base/paginate" .}}
                            {{end}}
                        {{else}}
                            <div class="ui message">
                                {{ctx.Locale.Tr "repo.commits.no_commits"}}
                            </div>
                        {{end}}
                    </div>
                    {{end}}
                {{end}}
            </div>
            {{end}}
        {{end}}
    </div>
</div>
{{template "base/footer" .}}
<script>
(function(){
  // Persist selection when clicking a row in the table
  var table = document.getElementById('articles-table');
  if (table) {
    table.querySelectorAll('tbody tr.article-row').forEach(function(tr){
      tr.addEventListener('click', function(){
        try {
          var owner = tr.getAttribute('data-owner') || '';
          var subject = tr.getAttribute('data-subject') || '';
          if (owner && subject) {
            window.localStorage.setItem('selectedArticleOwner', owner);
            window.localStorage.setItem('selectedArticleSubject', subject);
          }
        } catch(e) {}
      });
    });
  }

  // Intercept Article view tab click in header to redirect to last selected article
  var articleLink = document.getElementById('article-view-link');
  if (articleLink) {
    articleLink.addEventListener('click', function(ev){
      try {
        var owner = window.localStorage.getItem('selectedArticleOwner');
        var subject = window.localStorage.getItem('selectedArticleSubject');
        if (owner && subject) {
          ev.preventDefault();
          var base = (window.APP_SUB_URL || '');
          var url = base + '/article/' + encodeURIComponent(owner) + '/' + encodeURIComponent(subject) + '?view=article&mode=read';
          window.location.assign(url);
        }
      } catch(e) {}
    });
  }

  // If in subject context and no selection exists, show guidance message
  var guidance = document.getElementById('article-guidance');
  if (guidance) {
    try {
      var owner = window.localStorage.getItem('selectedArticleOwner');
      var subject = window.localStorage.getItem('selectedArticleSubject');
      if (!owner || !subject) guidance.style.display = '';
    } catch(e) { guidance.style.display = ''; }
  }

  // Hide tabs and content when no selection exists (subject article view)
  var tabs = document.getElementById('article-tabs');
  if (tabs) {
    try {
      var selOwner = window.localStorage.getItem('selectedArticleOwner');
      var selSubject = window.localStorage.getItem('selectedArticleSubject');
      var show = !!(selOwner && selSubject);
      if (!show) {
        tabs.style.display = 'none';
      }
    } catch(e) {}
  }

  // Sync table checkboxes with selection and update on change
  if (table) {
    try {
      var selOwner2 = window.localStorage.getItem('selectedArticleOwner');
      var selSubject2 = window.localStorage.getItem('selectedArticleSubject');
      table.querySelectorAll('tbody tr.article-row').forEach(function(tr){
        var cb = tr.querySelector('input.row-check');
        var rowOwner = tr.getAttribute('data-owner') || '';
        var rowSubject = tr.getAttribute('data-subject') || '';
        if (cb && selOwner2 && selSubject2) {
          cb.checked = (rowOwner === selOwner2 && rowSubject === selSubject2);
        }
        if (cb) {
          cb.addEventListener('change', function(ev){
            try {
              if (cb.checked) {
                window.localStorage.setItem('selectedArticleOwner', rowOwner);
                window.localStorage.setItem('selectedArticleSubject', rowSubject);
                // Untick other rows
                table.querySelectorAll('tbody tr.article-row input.row-check').forEach(function(other){ if (other !== cb) other.checked = false; });
              } else {
                // If the unchecked row was the selected, clear selection
                var curOwner = window.localStorage.getItem('selectedArticleOwner');
                var curSubject = window.localStorage.getItem('selectedArticleSubject');
                if (curOwner === rowOwner && curSubject === rowSubject) {
                  window.localStorage.removeItem('selectedArticleOwner');
                  window.localStorage.removeItem('selectedArticleSubject');
                }
              }
            } catch(e) {}
          });
        }
      });
    } catch(e) {}
  }

  // On click of Go to article, persist current row selection then navigate
  document.querySelectorAll('a.go-to-article').forEach(function(a){
    a.addEventListener('click', function(ev){
      var tr = (a.closest && a.closest('tr')) || null;
      var row = tr ? tr.previousElementSibling : null; // the article-row is before the desc row
      if (row && row.classList.contains('article-row')) {
        try {
          var rowOwner = row.getAttribute('data-owner') || '';
          var rowSubject = row.getAttribute('data-subject') || '';
          if (rowOwner && rowSubject) {
            window.localStorage.setItem('selectedArticleOwner', rowOwner);
            window.localStorage.setItem('selectedArticleSubject', rowSubject);
          }
        } catch(e) {}
      }
    });
  });
})();
</script>
