{{/* Template for rendering fork hierarchy nodes recursively */}}
{{define "fork_hierarchy_node"}}
    {{$node := .Node}}
    {{$currentRepo := .CurrentRepo}}
    {{$ctx := .ctx}}

    {{if and $node $node.Repository}}

    <div class="item fork-level-{{$node.Level}}">
        <div class="ui grid">
            <div class="two wide column">
                {{if $node.Repository.Owner}}
                    {{ctx.AvatarUtils.Avatar $node.Repository.Owner 32}}
                {{else}}
                    {{svg "octicon-person" 32}}
                {{end}}
            </div>
            <div class="fourteen wide column">
                <div class="content">
                    <div class="header">
                        {{/* Indentation indicators for hierarchy levels */}}
                        {{if gt $node.Level 0}}
                            {{if eq $node.Level 1}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                            {{if eq $node.Level 2}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                            {{if gt $node.Level 2}}<span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span><span class="ui basic mini label">{{svg "octicon-git-branch" 12}}</span>{{end}}
                        {{end}}

                        <a class="ui large text" href="/explore/articles/history/{{$node.Repository.Name}}">
                            <strong>{{if $node.Repository.Owner}}{{$node.Repository.Owner.Name}}{{else}}unknown{{end}}/{{$node.Repository.Name}}</strong>
                        </a>

                        <span class="ui small labels">
                            {{if eq $node.Level 0}}
                                <span class="ui blue label">
                                    {{svg "octicon-repo" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.root"}}
                                </span>
                            {{else}}
                                <span class="ui basic label">
                                    {{svg "octicon-repo-forked" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.fork"}}
                                </span>
                            {{end}}

                            {{if eq $node.Repository.FullName $currentRepo.FullName}}
                                <span class="ui green label">
                                    {{svg "octicon-eye" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.current"}}
                                </span>
                            {{end}}

                            {{if $node.Repository.IsPrivate}}
                                <span class="ui basic label">
                                    {{svg "octicon-lock" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.desc.private"}}
                                </span>
                            {{end}}

                            {{if $node.Repository.IsArchived}}
                                <span class="ui basic label">
                                    {{svg "octicon-archive" 12 "tw-mr-1"}}
                                    {{ctx.Locale.Tr "repo.desc.archived"}}
                                </span>
                            {{end}}
                        </span>
                    </div>

                    {{if $node.Repository.Description}}
                        <div class="description tw-mt-2">
                            {{$node.Repository.Description}}
                        </div>
                    {{end}}

                    <div class="extra tw-mt-3">
                        <div class="ui horizontal list">
                            <div class="item">
                                <i class="clock icon"></i>
                                {{if $node.Repository.UpdatedUnix}}
                                    {{ctx.Locale.Tr "repo.last_updated"}} {{DateUtils.TimeSince $node.Repository.UpdatedUnix}}
                                {{else}}
                                    {{ctx.Locale.Tr "repo.never_updated"}}
                                {{end}}
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/stars" class="ui basic mini label">
                                    {{svg "octicon-star" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumStars}}
                                </a>
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/forks" class="ui basic mini label">
                                    {{svg "octicon-repo-forked" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumForks}}
                                </a>
                            </div>
                            <div class="item">
                                <a href="{{$node.Repository.Link}}/issues" class="ui basic mini label">
                                    {{svg "octicon-issue-opened" 12 "tw-mr-1"}}
                                    {{CountFmt $node.Repository.NumIssues}}
                                </a>
                            </div>
                            {{if $node.Repository.PrimaryLanguage}}
                                <div class="item">
                                    <span class="ui basic mini label">
                                        <i class="circle icon" style="color: {{$node.Repository.PrimaryLanguage.Color}}"></i>
                                        {{$node.Repository.PrimaryLanguage.Language}}
                                    </span>
                                </div>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{/* Recursively render children */}}
    {{range $node.Children}}
        {{template "fork_hierarchy_node" (dict "Node" . "CurrentRepo" $currentRepo "ctx" $ctx)}}
    {{end}}
    {{end}}
{{end}}

{{template "base/head" .}}
<style>
/* Fork hierarchy level styling */
.fork-level-0 { margin-left: 0px !important; }
.fork-level-1 { margin-left: 20px !important; }
.fork-level-2 { margin-left: 40px !important; }
.fork-level-3 { margin-left: 60px !important; }
.fork-level-4 { margin-left: 80px !important; }
.fork-level-5 { margin-left: 100px !important; }
/* Articles table spacing */
#articles-table col.checkbox { width: 10px; }
#articles-table col.actions { width: 80px; }
</style>
<div role="main" aria-label="{{.Title}}" class="page-content repository file list">
    {{template "repo/header" .}}

    <div class="ui container">
        {{/* Wrapper for the 3 views controlled by query param "view" */}}

        {{if .IsRepoEmpty}}
            {{template "repo/empty" .}}
        {{else}}
            {{/* Bubble view placeholder - user will replace with Vue later */}}
            {{if .IsBubbleView}}
            <div class="ui segment">
                <div class="ui message">
                    <div class="header">Bubble view</div>
                    <p>This view will be provided by a Vue component.</p>
                </div>
            </div>
            {{end}}

            {{/* Table view */}}
            {{if .IsTableView}}
            <div class="ui stackable grid tw-mt-20">
                <div class="sixteen wide column">
                    <div class="tw-flex tw-items-center tw-justify-between tw-gap-4 tw-px-0 tw-border-0">
                        <h2 class="tw-text-xl tw-font-semibold tw-m-0">Articles</h2>
                        <div class="tw-flex tw-items-center tw-gap-2">
                            <div class="ui floating dropdown button tw-border-0 tw-bg-transparent tw-shadow-none tw-hover:bg-transparent tw-active:bg-transparent tw-pr-0">
                                <div style="transform: rotate(90deg);">
                                    {{svg "octicon-arrow-switch" 16}}
                                </div>
                                <span class="text tw-ml-1">Sort</span>
                                {{svg "octicon-triangle-down" 16 "tw-ml-1"}}
                                <div class="menu">
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "most_contrib"}}">Most contributors</a>
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "least_contrib"}}">Least contributors</a>
                                    <a class="item" href="{{QueryBuild (printf "%s/explore/articles/history/%s" AppSubUrl .Repository.Name) "view" "table" "sort" "latest"}}">Latest edited</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ui segment tw-px-0">
                        <table class="ui very basic fixed single line selectable table tw-mb-0" id="articles-table">
                            <colgroup>
                                <col class="checkbox">
                                <col>
                                <col>
                                <col>
                                <col class="actions">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th></th>
                                    <th class="five wide">Contributors</th>
                                    <th class="three wide">Last edited</th>
                                    <th class="four wide">Owner</th>
                                    <th class="collapsing"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range $idx, $f := .Files}}
                                {{$name := .Name}}
                                <tr class="article-row" data-row="{{$idx}}">
                                    <td>
                                        <div class="ui checkbox">
                                            <input type="checkbox" class="row-check">
                                            <label></label>
                                        </div>
                                    </td>
                                    <td class="tw-font-semibold">{{CountFmt $.ContributorCount}}</td>
                                    <td>{{if $.LastCommit}}{{DateUtils.AbsoluteShort $.LastCommit.Committer.When}}{{end}}</td>
                                    <td>{{if $.Repository.Owner}}{{$.Repository.Owner.Name}}{{else}}-{{end}}</td>
                                    <td class="collapsing tw-text-right">
                                        <button type="button" class="ui icon button row-toggle tw-border-0 tw-bg-transparent" data-target="desc-{{$idx}}" aria-label="Toggle description">
                                            <span class="icon-down">{{svg "octicon-chevron-down"}}</span>
                                            <span class="icon-up tw-hidden">{{svg "octicon-chevron-up"}}</span>
                                        </button>
                                    </td>
                                </tr>
                                <tr id="desc-{{$idx}}" class="tw-hidden">
                                    <td colspan="5">
                                        <div class="tw-pl-8 tw-pr-4 tw-py-4 tw-flex tw-items-start tw-justify-between tw-gap-4">
                                            <div class="tw-text-gray-600 tw-text-sm tw-leading-6">
                                                {{if $.Repository.Description}}
                                                    {{$.Repository.Description}}
                                                {{else}}
                                                    {{if $.LastCommit}}{{$.LastCommit.Summary}}{{end}}
                                                {{end}}
                                            </div>
                                            <a class="ui button" href="{{$.RepoLink}}/src/branch/{{$.BranchName}}/{{PathEscapeSegments $name}}">Go to article</a>
                                        </div>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                const table = document.getElementById('articles-table');
                if(!table) return;
                const selectAll = document.getElementById('select-all-articles');
                if (selectAll) {
                    selectAll.addEventListener('change', function(){
                        table.querySelectorAll('tbody .row-check').forEach(cb=>{ cb.checked = selectAll.checked; });
                    });
                }
                table.querySelectorAll('.row-toggle').forEach(btn=>{
                    btn.addEventListener('click', function(){
                        const id = this.getAttribute('data-target');
                        const row = document.getElementById(id);
                        if(!row) return;
                        row.classList.toggle('tw-hidden');
                        const down = this.querySelector('.icon-down');
                        const up = this.querySelector('.icon-up');
                        if (row.classList.contains('tw-hidden')) {
                            // now collapsed
                            if (down) down.classList.remove('tw-hidden');
                            if (up) up.classList.add('tw-hidden');
                        } else {
                            // now expanded
                            if (down) down.classList.add('tw-hidden');
                            if (up) up.classList.remove('tw-hidden');
                        }
                    });
                });
                // enable Fomantic dropdowns
                if (window.$ && $('.ui.dropdown').dropdown) { $('.ui.dropdown').dropdown(); }
            })();
            </script>
            {{end}}

            {{/* Article view - display README of repository (if exists) */}}
            {{if .IsArticleView}}
            <div class="ui stackable grid">
                <div class="sixteen wide column">
                    <div class="ui top attached tabular menu">
                        <a class="active item">
                            {{svg "octicon-file"}} {{ctx.Locale.Tr "repo.readme"}}
                        </a>
                    </div>
                    <div class="ui bottom attached segment">
                        <iframe src="{{.RepoLink}}" style="width:100%;border:0;min-height:60vh"></iframe>
                    </div>
                </div>
            </div>
            {{end}}
        {{end}}
    </div>
</div>
{{template "base/footer" .}}
