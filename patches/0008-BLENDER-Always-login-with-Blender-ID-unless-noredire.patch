From 4bb623a96762b5457e7b8c0724bd1c48fe004fc2 Mon Sep 17 00:00:00 2001
From: Brecht Van Lommel <brecht@blender.org>
Date: Fri, 10 May 2024 14:04:49 +0200
Subject: [PATCH 08/17] BLENDER: Always login with Blender ID, unless
 noredirect is specified

---
 routers/web/auth/auth.go | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/routers/web/auth/auth.go b/routers/web/auth/auth.go
index 87edbc357b..b98fad647a 100644
--- a/routers/web/auth/auth.go
+++ b/routers/web/auth/auth.go
@@ -164,6 +164,26 @@ func CheckAutoLogin(ctx *context.Context) bool {
 	return false
 }
 
+// BLENDER: always use OAuth unless ?noredirect=true is set
+func checkForceOAuth(ctx *context.Context) bool {
+	// Check if authentication is forced to OAuth
+	if ctx.FormBool("noredirect") {
+		return false
+	}
+
+	oauth2Providers, err := oauth2.GetOAuth2Providers(ctx, optional.Some(true))
+	if err != nil {
+		return false
+	}
+
+	for _, provider := range oauth2Providers {
+		ctx.Redirect(setting.AppSubURL + "/user/oauth2/" + provider.Name())
+		return true
+	}
+
+	return false
+}
+
 func prepareSignInPageData(ctx *context.Context) {
 	ctx.Data["Title"] = ctx.Tr("sign_in")
 	ctx.Data["OAuth2Providers"], _ = oauth2.GetOAuth2Providers(ctx, optional.Some(true))
@@ -185,6 +205,10 @@ func SignIn(ctx *context.Context) {
 	if CheckAutoLogin(ctx) {
 		return
 	}
+	// BLENDER: Check if authentication is forced to OAuth
+	if checkForceOAuth(ctx) {
+		return
+	}
 	if ctx.IsSigned {
 		RedirectAfterLogin(ctx)
 		return
-- 
2.49.0

